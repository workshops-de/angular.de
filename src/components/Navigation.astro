---
import NavigationBanner from './NavigationBanner.astro';
import { siteConfig } from '../config/site';

const currentPath = Astro.url.pathname;
const navItems = siteConfig.navigation.items;

const isActive = (pattern: string) => currentPath.includes(pattern);
---

<div class="sticky top-0 z-50 bg-white/95 dark:bg-gray-950/95 backdrop-blur-sm border-b border-gray-100 dark:border-gray-800">
  <NavigationBanner />

  <nav class="container mx-auto px-4">
    <div class="flex items-center h-18 py-3">
      <!-- Logo -->
      <a href="/" class="flex items-center flex-shrink-0">
        <img
          src="/assets/img/logo-with-poweredby.svg"
          alt={`${siteConfig.title} powered by workshops.de`}
          class="h-10 md:h-12 dark:brightness-0 dark:invert"
        />
      </a>

      <!-- Mobile menu button -->
      <button
        type="button"
        class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 ml-auto text-gray-700 dark:text-gray-300"
        aria-label="Toggle menu"
        onclick="document.getElementById('mobile-menu').classList.toggle('hidden')"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>

      <!-- Desktop navigation - centered -->
      <div class="hidden md:flex items-center justify-center gap-10 flex-1">
        {navItems.map(item => (
          <a
            href={item.href}
            class={`text-xl font-semibold transition-colors ${
              isActive(item.pattern)
                ? 'text-primary'
                : 'text-gray-700 dark:text-gray-300 hover:text-primary'
            }`}
            target={item.external ? '_blank' : undefined}
            rel={item.external ? 'noopener' : undefined}
          >
            {item.label}
          </a>
        ))}
      </div>

      <!-- Right side: Search + Language -->
      <div class="hidden md:flex items-center gap-4 flex-shrink-0">
        <!-- <form action="/suche/" method="GET" class="relative">
          <input
            name="q"
            type="search"
            placeholder="Suchen..."
            autocomplete="off"
            class="w-44 pl-4 pr-10 py-2.5 text-sm border border-gray-200 dark:border-gray-700 rounded-full focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 bg-gray-50 dark:bg-gray-800 dark:text-white dark:placeholder-gray-400"
          />
          <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-primary">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </form> -->

        <!-- Language Dropdown -->
        <div class="relative" id="lang-dropdown">
          <button
            id="lang-dropdown-btn"
            class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700"
          >
            <span id="current-lang">ðŸ‡©ðŸ‡ª</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown Menu -->
          <div id="lang-dropdown-menu" class="hidden absolute right-0 mt-2 w-36 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-100 dark:border-gray-700 py-1 z-50">
            <button
              class="lang-option w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2"
              data-lang="de"
            >
              <span class="text-base">ðŸ‡©ðŸ‡ª</span>
              Deutsch
            </button>
            <button
              class="lang-option w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2"
              data-lang="en"
            >
              <span class="text-base">ðŸ‡¬ðŸ‡§</span>
              English
            </button>
          </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button
          id="dark-mode-toggle"
          class="p-2.5 text-gray-600 dark:text-gray-300 hover:text-primary transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700"
          title="Dark Mode umschalten"
        >
          <!-- Sun icon (shown in dark mode) -->
          <svg class="w-4 h-4 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <!-- Moon icon (shown in light mode) -->
          <svg class="w-4 h-4 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>
      </div>

      <!-- Google Translate Element (hidden) -->
      <div id="google_translate_element" class="hidden"></div>
    </div>

    <!-- Mobile navigation with language option -->
    <div id="mobile-menu" class="hidden md:hidden pb-4">
      <div class="flex flex-col gap-2">
        {navItems.map(item => (
          <a
            href={item.href}
            class={`px-4 py-2 rounded-lg font-medium ${
              isActive(item.pattern)
                ? 'bg-purple-50 dark:bg-purple-900/30 text-primary'
                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800'
            }`}
            target={item.external ? '_blank' : undefined}
            rel={item.external ? 'noopener' : undefined}
          >
            {item.label}
          </a>
        ))}
        <!-- <form action="/suche/" method="GET" class="px-4 pt-2">
          <input
            name="q"
            type="search"
            placeholder="Suchen..."
            autocomplete="off"
            class="w-full px-4 py-2 text-sm border border-gray-200 dark:border-gray-700 rounded-full focus:outline-none focus:border-primary dark:bg-gray-800 dark:text-white dark:placeholder-gray-400"
          />
        </form> -->

        <!-- Mobile Language & Dark Mode -->
        <div class="px-4 pt-2 flex gap-2">
          <button
            class="lang-option-mobile flex-1 py-2 rounded-lg font-medium text-sm border border-gray-200 dark:border-gray-700 flex items-center justify-center gap-2 bg-purple-50 dark:bg-purple-900/30 text-primary"
            data-lang="de"
          >
            ðŸ‡©ðŸ‡ª Deutsch
          </button>
          <button
            class="lang-option-mobile flex-1 py-2 rounded-lg font-medium text-sm border border-gray-200 dark:border-gray-700 flex items-center justify-center gap-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800"
            data-lang="en"
          >
            ðŸ‡¬ðŸ‡§ English
          </button>
          <button
            id="dark-mode-toggle-mobile"
            class="py-2 px-4 rounded-lg font-medium text-sm border border-gray-200 dark:border-gray-700 flex items-center justify-center gap-2 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800"
          >
            <svg class="w-4 h-4 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <svg class="w-4 h-4 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>
</div>

<!-- Google Translate Script -->
<script is:inline>
  // Google Translate initialization
  window.googleTranslateElementInit = function() {
    try {
      new google.translate.TranslateElement({
        pageLanguage: 'de',
        includedLanguages: 'en',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');

      // After initialization, trigger translation if needed
      if (window.pendingTranslation === 'en') {
        setTimeout(() => {
          const select = document.querySelector('.goog-te-combo');
          if (select) {
            select.value = 'en';
            select.dispatchEvent(new Event('change'));
            updateLangDisplay('en');
          }
        }, 500);
      }
    } catch (e) {
      console.error('Google Translate initialization failed:', e);
    }
  }

  // Load Google Translate script
  function loadGoogleTranslate() {
    if (window.googleTranslateLoaded) return Promise.resolve();

    return new Promise((resolve) => {
      const script = document.createElement('script');
      script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
      script.async = true;
      script.onload = () => {
        window.googleTranslateLoaded = true;
        resolve();
      };
      script.onerror = () => {
        console.error('Failed to load Google Translate');
        resolve();
      };
      document.body.appendChild(script);
    });
  }

  // Switch language
  async function switchLanguage(lang) {
    if (lang === 'en') {
      // Check if on localhost - Google Translate doesn't work locally
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        alert('Google Translate funktioniert nicht auf localhost. Bitte auf einer Ã¶ffentlichen URL testen (z.B. Firebase/Vercel Preview).');
        return;
      }

      window.pendingTranslation = 'en';
      await loadGoogleTranslate();

      // If already loaded, trigger translation immediately
      if (window.googleTranslateLoaded) {
        const select = document.querySelector('.goog-te-combo');
        if (select) {
          select.value = 'en';
          select.dispatchEvent(new Event('change'));
          updateLangDisplay('en');
        }
      }
    } else {
      // Reset to German
      window.pendingTranslation = null;

      // Method 1: Try to click restore button
      const iframe = document.querySelector('.goog-te-banner-frame');
      if (iframe) {
        try {
          const innerDoc = iframe.contentDocument || iframe.contentWindow.document;
          const restoreBtn = innerDoc.querySelector('.goog-te-button button');
          if (restoreBtn) {
            restoreBtn.click();
            updateLangDisplay('de');
            document.getElementById('lang-dropdown-menu')?.classList.add('hidden');
            return;
          }
        } catch (e) {
          // Cross-origin iframe, can't access
        }
      }

      // Method 2: Clear cookies and reload
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + location.hostname;
      location.reload();
    }

    // Close dropdown
    document.getElementById('lang-dropdown-menu')?.classList.add('hidden');
  }

  // Update display
  function updateLangDisplay(lang) {
    const currentLang = document.getElementById('current-lang');
    if (currentLang) {
      currentLang.textContent = lang === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡©ðŸ‡ª';
    }

    // Update mobile buttons
    document.querySelectorAll('.lang-option-mobile').forEach(btn => {
      const isActive = btn.dataset.lang === lang;
      btn.classList.toggle('bg-purple-50', isActive);
      btn.classList.toggle('text-primary', isActive);
      btn.classList.toggle('text-gray-700', !isActive);
    });
  }

  // Toggle dropdown
  document.getElementById('lang-dropdown-btn')?.addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('lang-dropdown-menu')?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    document.getElementById('lang-dropdown-menu')?.classList.add('hidden');
  });

  // Language option clicks (desktop)
  document.querySelectorAll('.lang-option').forEach(btn => {
    btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
  });

  // Language option clicks (mobile)
  document.querySelectorAll('.lang-option-mobile').forEach(btn => {
    btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
  });

  // Check if already translated on load
  if (document.cookie.includes('googtrans=/de/en')) {
    updateLangDisplay('en');
  }

  // ==================== DARK MODE ====================
  // Following Tailwind CSS docs: https://tailwindcss.com/docs/dark-mode#toggling-dark-mode-manually

  // Toggle dark mode
  function toggleDarkMode() {
    const isDark = document.documentElement.classList.contains('dark');
    if (isDark) {
      // User explicitly chooses light mode
      document.documentElement.classList.remove('dark');
      localStorage.theme = 'light';
    } else {
      // User explicitly chooses dark mode
      document.documentElement.classList.add('dark');
      localStorage.theme = 'dark';
    }
  }

  // Listen for system theme changes (only when no explicit user preference)
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!('theme' in localStorage)) {
      document.documentElement.classList.toggle('dark', e.matches);
    }
  });

  // Dark mode toggle buttons
  document.getElementById('dark-mode-toggle')?.addEventListener('click', toggleDarkMode);
  document.getElementById('dark-mode-toggle-mobile')?.addEventListener('click', toggleDarkMode);
</script>

<style is:global>
  /* Hide Google Translate banner */
  .goog-te-banner-frame {
    display: none !important;
  }

  body {
    top: 0 !important;
  }

  .goog-te-gadget {
    font-size: 0 !important;
  }

  .skiptranslate {
    display: none !important;
  }

  /* Style the translate button when active */
  .translated-ltr #translate-btn,
  .translated-ltr .translate-btn-mobile {
    color: var(--color-primary);
  }
</style>
