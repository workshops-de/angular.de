---
/**
 * Language Picker Component
 * Displays current language and allows switching between available languages
 */
import { languages, defaultLang, type Lang } from "../i18n/ui";
import { getLangFromUrl, useTranslatedPath, getRouteFromUrl } from "../i18n/utils";

const currentLang = getLangFromUrl(Astro.url);
const route = getRouteFromUrl(Astro.url);

// Get translation slug from Astro.locals if available (set by article pages)
const translationSlug = Astro.locals.translationSlug;

// Get the rest of the path after the route (e.g., article slugs)
const pathParts = Astro.url.pathname.split("/").filter(Boolean);
const langIndex = currentLang !== defaultLang ? 1 : 0;
const restOfPath = pathParts.slice(langIndex + 1).join("/");
---

<div class="relative" id="lang-picker">
  <button
    id="lang-picker-btn"
    class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 border border-gray-200 dark:border-gray-700"
    aria-label="Switch language"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <span>{currentLang === "de" ? "ðŸ‡©ðŸ‡ª" : "ðŸ‡¬ðŸ‡§"}</span>
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <div
    id="lang-picker-menu"
    class="hidden absolute right-0 mt-2 w-36 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-100 dark:border-gray-700 py-1 z-50"
  >
    {Object.entries(languages).map(([lang, label]) => {
      const translatePath = useTranslatedPath(lang as Lang);
      const isActive = lang === currentLang;

      // Build the href based on whether we have a translation slug
      let href: string;

      if (translationSlug && route === 'artikel') {
        // We're on an article page with a translation
        if (lang === 'de') {
          href = `/artikel/${translationSlug}/`;
        } else {
          href = `/en/articles/${translationSlug}/`;
        }
      } else {
        // Default behavior for non-article pages
        const basePath = route ? translatePath(`/${route}/`) : translatePath("/");
        href = restOfPath ? `${basePath}${restOfPath}` : basePath;
      }

      return (
        <a
          href={href}
          class:list={[
            "block w-full px-4 py-2 text-left text-sm flex items-center gap-2 transition-colors",
            isActive
              ? "bg-primary-50 dark:bg-primary-900/30 text-primary font-medium"
              : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
          ]}
          aria-current={isActive ? "page" : undefined}
        >
          <span class="text-base">{lang === "de" ? "ðŸ‡©ðŸ‡ª" : "ðŸ‡¬ðŸ‡§"}</span>
          {label}
        </a>
      );
    })}
  </div>
</div>

<script>
  function initLanguagePicker() {
    const btn = document.getElementById("lang-picker-btn");
    const menu = document.getElementById("lang-picker-menu");

    if (!btn || !menu) return;

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", (!isExpanded).toString());
      menu.classList.toggle("hidden");
    });

    // Close when clicking outside
    document.addEventListener("click", () => {
      btn.setAttribute("aria-expanded", "false");
      menu.classList.add("hidden");
    });

    // Close on escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        btn.setAttribute("aria-expanded", "false");
        menu.classList.add("hidden");
      }
    });
  }

  // Initialize on page load and after Astro navigation
  initLanguagePicker();
  document.addEventListener("astro:page-load", initLanguagePicker);
</script>

